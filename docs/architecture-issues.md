# Архитектурные риски и пути их устранения

## 1. Управление сессиями без переиспользования
`YdbClientWrapper.executeQuery` создаёт новую сессию для каждого вне-транзакционного запроса и сразу же её удаляет (`createSession`/`deleteSession`). При высокой нагрузке это приводит к большому количеству gRPC-вызовов `createSession`/`attachSession`, которые YDB считает дорогими, и лишает нас преимуществ серверного кеша подготовленных запросов.【F:src/client-wrapper.ts†L92-L183】【F:src/client-wrapper.ts†L320-L349】

**Что сделать:** вынести управление сессиями в отдельный пул (например, очередь `SessionContext` с TTL), который будет предоставлять живые сессии для автокоммита и возвращать их после запроса. Это позволит повторно использовать подготовленные запросы и снизить нагрузку на кластеры YDB.

## 2. Протечки при неуспешном завершении транзакций
`commitTransaction` и `rollbackTransaction` освобождают сессию и чистят карту транзакций только после успешного ответа. Любая ошибка (сетевой таймаут, конфликт) приводит к утечке `TransactionContext` и неосвобождённой сессии, потому что `deleteSession` и `transactions.delete` не вызываются в `finally`-блоке.【F:src/client-wrapper.ts†L249-L279】

**Что сделать:** обернуть освобождение ресурсов в `try/finally`, чтобы сессия удалялась и запись в `transactions` сбрасывалась независимо от результата RPC, а при ошибке дополнительно инициировать `rollback`/`forget`.

## 3. Жёстко зашитый провайдер `postgres`
И `YdbQueryable`, и фабрика возвращают `provider = 'postgres'`, чтобы удовлетворить текущий контракт Prisma. Такое переопределение нарушает инварианты `prisma migrate`/`introspect` (они ожидают поведение PostgreSQL), а будущая поддержка специфики YDB будет затруднена.【F:src/queryable.ts†L11-L48】【F:src/adapter-factory.ts†L15-L54】

**Что сделать:** договориться с командой Prisma о регистрации отдельного провайдера `ydb` в `driver-adapter-utils`, а до тех пор инкапсулировать хак в отдельном адаптере-совместимости. Это предотвратит распространение PostgreSQL-специфичных ожиданий по всему коду и позволит постепенно вводить YDB-специфичное поведение.

## 4. Класс `YdbClientWrapper` перегружен ответственностями
Класс одновременно отвечает за установку соединения, пул транзакций, трансформацию SQL плейсхолдеров, кодирование параметров и нормализацию результатов. Это усложняет тестирование и переиспользование отдельных слоёв (например, маппинга типов).【F:src/client-wrapper.ts†L76-L401】

**Что сделать:** разделить функциональность на несколько компонентов: менеджер соединений/сессий, модуль трансляции аргументов, модуль нормализации результатов и сервис транзакций. Это облегчит замену/мокирование отдельных слоёв и позволит независимо оптимизировать, например, кодирование параметров и работу сессий.
